from unittest.mock import MagicMock

from service.abonnement_service import AbonnementService

from dao.abonnement_dao import AbonnementDao

from business_object.abonnement import Abonnement


liste_abonnements = [
    Abonnement(id_utilisateur_suiveur=123, id_utilisateur_suivi = 456),
    Abonnement(id_utilisateur_suiveur=123, id_utilisateur_suivi = 488),
    Abonnement(id_utilisateur_suiveur=100, id_utilisateur_suivi = 123),
]


def test_creer_ok():
    """ "Création de Abonnement réussie"""

    # GIVEN
    id_utilisateur_suiveur, id_utilisateur_suivi = 123, 456
    AbonnementDao().creer = MagicMock(return_value=True)

    # WHEN
    abonnement = AbonnementService().creer(id_utilisateur_suiveur, id_utilisateur_suivi)

    # THEN
    assert abonnement.id_utilisateur_suiveur == id_utilisateur_suiveur and abonnement.id_utilisateur_suivi == id_utilisateur_suivi


def test_creer_echec():
    """Création de Abonnement échouée
    (car la méthode AbonnementDao().creer retourne False)"""

    # GIVEN
    id_utilisateur_suiveur, id_utilisateur_suivi = 123, 456
    AbonnementDao().creer = MagicMock(return_value=False)

    # WHEN
    abonnement = AbonnementService().creer(id_utilisateur_suiveur, id_utilisateur_suivi)

    # THEN
    assert joueur is None



def test_lister_utilisateurs_suivis_succes():
    """Lister les utilisateurs suivis"""

    """ A COMPLETER """

    # GIVEN
    AbonnementDao().lister_suivis = MagicMock(return_value=liste_abonnements)

    # WHEN
    res = AbonnementService().lister_utilisateurs_suivis()

    # THEN
    assert len(res) == 3
    for joueur in res:
        assert joueur.mdp is not None


    @log
    def lister_utilisateurs_suivis(self) -> list[Joueur]:
        """Lister tous les joueurs qui sont suivis par abonnement
        """
        joueurs = JoueurDao().lister_tous()
        abonnements = AbonnementDao().lister_suivis
        utilisateurs_suivis <- set()
        for j in joueurs:
                id1 = j.id_joueur
                for k in abonnements:
                    id2 = k.id_joueur
                    if id1 == id2:
                        utilisateurs_suivis.add(j)
        return utilisateurs_suivis





def test_lister_tous_inclure_mdp_false():
    """Lister les Joueurs en excluant les mots de passe"""

    # GIVEN
    JoueurDao().lister_tous = MagicMock(return_value=liste_joueurs)

    # WHEN
    res = JoueurService().lister_tous()

    # THEN
    assert len(res) == 3
    for joueur in res:
        assert not joueur.mdp


def test_pseudo_deja_utilise_oui():
    """Le pseudo est déjà utilisé dans liste_joueurs"""

    # GIVEN
    pseudo = "lea"

    # WHEN
    JoueurDao().lister_tous = MagicMock(return_value=liste_joueurs)
    res = JoueurService().pseudo_deja_utilise(pseudo)

    # THEN
    assert res


def test_pseudo_deja_utilise_non():
    """Le pseudo n'est pas utilisé dans liste_joueurs"""

    # GIVEN
    pseudo = "chaton"

    # WHEN
    JoueurDao().lister_tous = MagicMock(return_value=liste_joueurs)
    res = JoueurService().pseudo_deja_utilise(pseudo)

    # THEN
    assert not res


if __name__ == "__main__":
    import pytest

    pytest.main([__file__])
